# KeypathRecorder

> A lean macOS utility for creating keyboard mappings in under 60 seconds — no config file editing required.

[![Build Status](https://github.com/malpern/keypath-recorder/actions/workflows/ci.yml/badge.svg)](https://github.com/malpern/keypath-recorder/actions)
[![macOS](https://img.shields.io/badge/macOS-14%2B-blue)](https://developer.apple.com/macos/)
[![Swift](https://img.shields.io/badge/Swift-5.9-orange)](https://swift.org)
[![Rust](https://img.shields.io/badge/Rust-1.70-red)](https://www.rust-lang.org)

## Overview

KeypathRecorder eliminates the friction of keyboard remapping on macOS by providing a simple visual interface to capture key presses and generate [Kanata](https://github.com/jtroo/kanata) configuration files automatically.

**Quick Demo:**
1. Click "Start" and press any key → captures as raw scan-code
2. Type your desired output sequence → "Hello World!"
3. Click "Save" → generates `.kbd` file ready for Kanata

## Features

- **Visual Key Capture**: Click and press any key to capture its scan-code
- **Intuitive Output**: Type exactly what you want the key to produce
- **Automatic Config Generation**: Creates proper Kanata `.kbd` files
- **File Management**: Organized timestamped output files
- **Kanata Integration**: Direct compatibility with Kanata keyboard engine
- **Cross-Platform Core**: Rust core library works on macOS, Linux, Windows

## Status: Fully Functional MVP ✅

KeypathRecorder has achieved its primary milestone with a complete end-to-end workflow:

- ✅ **Core functionality complete** - Key capture, mapping, and export working
- ✅ **Comprehensive testing** - 48 tests across Rust and Swift components
- ✅ **User experience optimized** - Complete workflow achievable in <60 seconds
- ✅ **Production ready** - Robust error handling and file management

## Installation

### Prerequisites

- macOS 14.0+ (Sonoma or later)
- [Kanata](https://github.com/jtroo/kanata) keyboard engine
- Xcode 15.0+ (for building from source)

### Install Kanata

```bash
brew install kanata
```

### Build from Source

```bash
git clone https://github.com/malpern/keypath-recorder.git
cd keypath-recorder

# Build Rust core
cargo build --release

# Build Swift app
cd KeypathRecorder
swift build
```

## Usage

### Basic Workflow

1. **Launch the app** from Finder (not Terminal - this is important!)
2. **Click "Start Capture"** and press the key you want to remap
3. **Type your output sequence** in the text field
4. **Click "Save & Prepare"** to generate the Kanata configuration
5. **Follow the displayed instructions** to launch Kanata with sudo

### Example: Remap CapsLock to "Hello World!"

```
1. Start capture → Press CapsLock
   Display shows: "Captured: CapsLock (0x39)"

2. Enter output: "Hello World!"

3. Save generates file: ~/Documents/keypath_20250714_094523.kbd
   
4. Run in Terminal:
   sudo kanata --cfg ~/Documents/keypath_20250714_094523.kbd
```

### Generated Kanata Configuration

KeypathRecorder creates optimized Kanata configurations:

```lisp
;; Generated by KeypathRecorder
(defcfg
  process-unmapped-keys yes
  log-layer-changes no
)

(defsrc
  caps
)

(deflayer default
  (macro H e l l o spc W o r l d !)
)
```

## Architecture

### Hybrid Swift-Rust Design

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   SwiftUI App   │    │   Rust Core      │    │  Kanata Engine  │
│                 │    │                  │    │                 │
│ • Key Capture   │◄──►│ • IR Processing  │──► │ • Key Remapping │
│ • File Management│    │ • Validation     │    │ • System Events │
│ • User Interface│    │ • Export Logic   │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Core Components

- **`keypath_core`** - Rust library for IR processing and Kanata export
- **`keypath_cli`** - Command-line interface for batch processing
- **`KeypathRecorder`** - SwiftUI app for interactive key mapping
- **FFI Bridge** - Seamless Swift-Rust interoperability

## Testing

The project maintains comprehensive test coverage:

```bash
# Run Rust tests
cargo test

# Run Swift tests
cd KeypathRecorder && swift test

# Full test suite
./test.sh
```

**Test Coverage:**
- 27 Rust tests covering IR processing, validation, and export
- 21 Swift tests covering UI, file management, and integration
- Integration tests for end-to-end workflow verification

## Current Limitations

### Manual Sudo Requirement
Users must manually run Kanata with sudo privileges:
```bash
sudo kanata --cfg /path/to/generated/config.kbd
```

### Kanata Conflicts
Only one keyboard remapping tool can run at a time. Disable Karabiner-Elements before using Kanata.

### Single Mapping Files
Each mapping creates a separate `.kbd` file. Multiple mappings require manual file combination.

## Roadmap

### Phase 1: Enhanced User Experience
- [ ] **Privileged Helper Tool** - Eliminate manual sudo requirement using SMAppService
- [ ] **Multi-mapping Support** - Combine multiple mappings into single config
- [ ] **Conflict Detection** - Detect and warn about Karabiner-Elements conflicts

### Phase 2: Advanced Features
- [ ] **Tap/Hold Mappings** - Support for complex key behaviors
- [ ] **Macro Recording** - Record and replay key sequences
- [ ] **Device-Specific Mappings** - Per-keyboard configuration support

### Phase 3: Distribution
- [ ] **Code Signing** - Proper Apple Developer certificate
- [ ] **Notarized DMG** - App Store-ready distribution
- [ ] **Auto-Update** - Seamless update mechanism

## Development

### Project Structure

```
keypath-recorder/
├── keypath_core/           # Rust core library
│   ├── src/
│   │   ├── lib.rs         # Public API
│   │   ├── ir.rs          # Intermediate representation
│   │   ├── export.rs      # Kanata export logic
│   │   └── bridge.rs      # FFI bindings
│   └── Cargo.toml
├── keypath_cli/           # Command-line interface
│   └── src/main.rs
├── KeypathRecorder/       # SwiftUI application
│   ├── Sources/
│   │   └── KeypathRecorder/
│   │       ├── ContentView.swift
│   │       ├── KeyboardCapture.swift
│   │       └── RustBridge.swift
│   └── Package.swift
└── README.md
```

### Building

```bash
# Rust development
cargo build
cargo test
cargo clippy

# Swift development
cd KeypathRecorder
swift build
swift test
```

### Contributing

1. **Fork the repository**
2. **Create a feature branch** (`git checkout -b feature/amazing-feature`)
3. **Run tests** (`cargo test && swift test`)
4. **Commit changes** (`git commit -m 'Add amazing feature'`)
5. **Push to branch** (`git push origin feature/amazing-feature`)
6. **Open a Pull Request**

## Technical Details

### Intermediate Representation (IR)

KeypathRecorder uses a JSON-based intermediate representation:

```json
{
  "version": "1.0",
  "mappings": [
    {
      "key": {
        "scan_code": 57,
        "name": "CapsLock"
      },
      "action": {
        "type": "Macro",
        "sequence": "Hello World!"
      }
    }
  ]
}
```

### Kanata Export Logic

The Rust core transforms IR into optimized Kanata configuration:

```rust
pub fn export_kanata(ir: &IR) -> Result<String, ExportError> {
    let mut config = String::new();
    config.push_str(&generate_defcfg());
    config.push_str(&generate_defsrc(&ir.mappings));
    config.push_str(&generate_deflayer(&ir.mappings));
    Ok(config)
}
```

### Swift-Rust Integration

FFI bridge enables seamless data exchange:

```swift
// Swift calling Rust
let result = create_mapping_json(keyCode, keyName, outputSequence)
let kanataConfig = export_to_kanata(jsonString)
```

## Performance

- **Key capture latency**: <10ms via CGEvent
- **Export generation**: <50ms for typical mappings
- **File I/O**: <100ms for configuration save
- **Memory usage**: <5MB typical runtime footprint

## Security

- **Input monitoring permission** required for key capture
- **Accessibility permission** required for some key events
- **No network access** - all processing local
- **Temporary files** cleaned up automatically

## Troubleshooting

### App Not Capturing Keys
- **Launch from Finder**, not Terminal
- Grant **Accessibility** permission in System Settings
- Grant **Input Monitoring** permission in System Settings

### Kanata Not Starting
- Verify Kanata installation: `which kanata`
- Check configuration syntax: `kanata --check /path/to/config.kbd`
- Ensure no other keyboard tools are running

### Build Issues
- Update Xcode to 15.0+
- Install Rust 1.70+: `rustup update`
- Clear build cache: `cargo clean && swift package clean`

## License

MIT License - see [LICENSE](LICENSE) file for details.

## Acknowledgments

- [Kanata](https://github.com/jtroo/kanata) - The keyboard engine that powers remapping
- [jtroo](https://github.com/jtroo) - Creator of Kanata
- Swift and Rust communities for excellent tooling and documentation

---

**Target**: macOS 14+ • **Status**: Fully Functional MVP • **Next**: Privileged Helper Implementation